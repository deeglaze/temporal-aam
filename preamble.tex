\input{common}
\usepackage{textcomp,wasysym}
\usepackage{amsmath,stmaryrd}
\usepackage{pfsteps}
% Switches for verbosity
\newcommand*{\ifproof}[1]{#1}

\newcommand*{\dfm}{\citeauthor{ianjohnson:dfm:icfp2011}}

% Metavariables
\newcommand*{\matchstate}{\mu}
\newcommand*{\mconstructor}{c}
\newcommand*{\matom}{a}
\newcommand*{\mdata}{v}
\newcommand*{\mpat}{\mathit{pat}}
\newcommand*{\mpatset}{\mathit{P}}
\newcommand*{\msubpat}{\mathit{subpat}}
\newcommand*{\pmsmq}{q}
\newcommand*{\pmsmqq}{s}
\newcommand*{\pmsmqcur}{s_\mathit{cur}}
\newcommand*{\pmsmqlast}{s_\mathit{last}}
\newcommand*{\stackop}{\pm\epsilon}
\newcommand*{\pmsmstate}[1]{\langle #1 \rangle}
\newcommand*{\pmsmstateM}[2]{\pmsmstate{#1}_{#2}}
\newcommand*{\pmsmMachine}{M}
\newcommand*{\npmsm}[2]{\langle #1,\ #2\rangle}
\newcommand*{\ary}{\mathit{ary}}

\newcommand*{\mbindenv}{\gamma}
\newcommand*{\mbindstack}{\Gamma}
\newcommand*{\mres}{\mathit{result}}
\newcommand*{\meqs}{I}

\newcommand*{\mprog}{p}
\newcommand*{\mdef}{D}
\newcommand*{\mcontract}{C}
\newcommand*{\mscon}{S}
\newcommand*{\mtcon}{T}
\newcommand*{\mname}{n}
\newcommand*{\mtoplevelname}{\ell}
\newcommand*{\mevent}{A}
\newcommand*{\mbevent}{B}
\newcommand*{\mconstant}{c}
\newcommand*{\mvpat}{p}
\newcommand*{\mfnpat}{f}
\newcommand*{\mcontracts}{{\mathcal C}}
\newcommand*{\mnames}{N}
\newcommand*{\premons}{P}

\newcommand*{\mnode}{u}

\newcommand*{\mgraph}{G}
\newcommand*{\maccum}{T_{\mathit{acc}}}

\newcommand*{\mctx}[1]{\mathit{E}^{#1}}
\WithSuffix\newcommand\mctx*{\mctx{\toplevel}}
\newcommand*{\mTMons}{\tau}
\newcommand*{\mtrace}{\pi}
\newcommand*{\mtimeline}{\eta}
\newcommand*{\matimeline}{\hat{\eta}}
\newcommand*{\mstimeline}{\eta}
\newcommand*{\msmlab}{\ell^{\toplevel}{}}
\newcommand*{\mmlab}{\ell}
\newcommand*{\mmaddr}{a_m}
\newcommand*{\mpval}{v_\mathit{pre}}
\newcommand*{\mframe}{\phi}
\newcommand*{\mmsto}{\sigma_{\mathcal C}}

\newcommand*{\mvariance}{\pm}
\newcommand*{\varianceite}[3]{\text{if } #1 > 0 ? #2 : #3}

\newcommand*{\mtestack}{\Xi}
\newcommand*{\emptytestack}{\epsilon}
\newcommand*{\cons}[2]{#1{\tt :}#2}

\newcommand*{\mbmachine}{M_\mbindenv}
\newcommand*{\machnull}{M_\varnothing}
\newcommand*{\macheps}{M_\epsilon}
\newcommand*{\mvaluation}{t}
\newcommand*{\truev}[1]{\checkmark_{#1}}
\newcommand*{\maybev}[1]{?_{#1}}
\newcommand*{\rejecting}{\times}
\newcommand*{\machtop}[2]{{#1}^{#2}}
\newcommand*{\mquality}{\zeta}
\newcommand*{\forprefix}{P}
\newcommand*{\forfull}{F}

\newcommand*{\toplevel}{\Lambda}

% Functions
\newcommand*{\filter}{\mathit{filter}}
\newcommand*{\accept}{\mathit{accept}}
\newcommand*{\convertcons}{\mathit{convert}}
\newcommand*{\toltl}[5]{\llparenthesis #2 \rrparenthesis_{#3,\,#4}^{#1}(#5)}
\newcommand*{\stacktoltl}[3]{\llparenthesis #2 \rrparenthesis_{#3}^{#1}}

\newcommand*{\matches}{\mathit{matches}}

\newcommand*{\weakif}{\mathit{weak\text{-}if}}
\newcommand*{\nnf}{{\mathcal N}}
\newcommand*{\prefixes}{\mathit{prefixes}}
\newcommand*{\smooth}{\mathit{smooth}}

\newcommand*{\wf}{\mathit{wf}}

\newcommand*{\vpatToPattern}{\mathit{ppat}}
\newcommand*{\vpatToData}{\mathit{vpat}}

\newcommand*{\matchcall}{\mathit{mcall}}
\newcommand*{\matchret}{\mathit{mret}}
\newcommand*{\matchv}{\mathit{mv}}
\newcommand*{\restricttoreachable}{{\mathcal R}{\mathcal R}}
\newcommand*{\splitpattern}{\mathit{split}}

\newcommand*{\match}{\mathit{match}}
\newcommand*{\matchset}{\mathit{matchset}}
\newcommand*{\submatch}{\mathit{submatch}}
\newcommand*{\labelof}{{\mathcal L}}
\newcommand*{\paths}{\mathit{paths}}
\newcommand*{\traces}{\mathit{traces}}

\newcommand*{\epshelp}{{\mathcal M}_\epsilon}
\newcommand*{\epsclose}{\epsilon\text{-}\mathit{close}}
\newcommand*{\translateeps}{\mathit{translate}}

\newcommand*{\timelineis}[2]{#1 \mathrel{\mathit{on}} #2}
\newcommand*{\labelis}[2]{#1 \mathrel{\mathit{labeled}} #2}


% Syntax
\newcommand*{\smay}[1]{{\tt may}(#1)}
\newcommand*{\smust}[1]{{\tt must}(#1)}

\newcommand*{\sSMon}[6]{\tuple*[^{#1,#2}_{#3}]{smon}{#4}{#5,\, #6}}
\newcommand*{\sTMon}[6]{\tuple[^{#1,#2}_{#3}]{tmon}{#4,\,#5,\,#6}}
\newcommand*{\schk}[4]{\tuple[^{#1}_{#2}]{chk}{#3,\, #4}}
\WithSuffix\newcommand\schk*[5]{\tuple*[^{#1}_{#2}]{chk}{#3}{#4,\, #5}}
\DeclarePairedDelimiter\own{\lbag}{\rbag}%
\DeclarePairedDelimiter\Own{\lbag\mkern-6mu\lbag}{\rbag\mkern-6mu\rbag}%
\newcommand*{\sown}[2]{\own{#1}^{#2}}
\newcommand*{\sOwn}[2]{\Own{#1}^{#2}}
\WithSuffix\newcommand\sown*[2]{\floor{#1}^{\overline{#2}}}
\newcommand*{\hole}{[\,]}
\newcommand*{\sblame}[2]{{\tt blame}^{#1}_{#2}}
\newcommand*{\scall}[3]{\tuple*[^{#1}]{call}{#2}{#3}}
\newcommand*{\sret}[3]{\tuple*[^{#1}]{ret}{#2}{#3}}
\newcommand*{\smachine}{\mathcal{M}}

\newcommand*{\sdefine}[3][\ ]{\tuple[#1]{define}{#2,\, #3}}
\newcommand*{\sdefinec}[4][\ ]{\tuple[#1]{define/contract}{#2,\,#3,\,#4}}
\newcommand*{\sunit}{{\tt '()}}
\newcommand*{\semptyp}{{\tt null?}}
\newcommand*{\sconsc}[2]{\chevron{#1,\, #2}}
\newcommand*{\scons}{\tt cons}
\newcommand*{\scar}{{\tt car}}
\newcommand*{\scdr}{{\tt cdr}}
\newcommand*{\spairp}{{\tt pair?}}

\newcommand*{\pmsmpair}[2]{\langle #1, #2 \rangle}

\newcommand*{\sbind}[1]{{\tt ?} #1}
\newcommand*{\sref}[1]{{\tt \$} #1}

\newcommand*{\semneg}[1]{\neg #1}
\newcommand*{\semseq}{\mathrel{\denote{\cdot}}}
\newcommand*{\stOr}[1]{\cup #1}
\newcommand*{\stAnd}[1]{\cap #1}
\newcommand*{\stseq}[2]{#1 \cdot #2}
\newcommand*{\stmany}[1]{#1^*}

\newcommand*{\stbind}[2]{\langle #1\rangle\ #2}

\newcommand*{\stcall}[3]{\scallev{#1}{{\tt ?}#2}\ #3}
\newcommand*{\stret}[3]{\sretev{#1}{{\tt ?}#2}\ #3}

\newcommand*{\stnot}[1]{\neg #1}
\newcommand*{\sddd}{{\tt ...}}
\newcommand*{\stfail}{\bot}
\newcommand*{\snonevent}[1]{! #1}

\newcommand*{\sarr}[3]{#1 : #2 \mapsto #3}
\newcommand*{\sflat}[1]{{\tt flat}(#1)}

\newcommand*{\doneev}{{\tt End}}
\newcommand*{\scallev}[2]{{\tt call}(#1,\, #2)}
\newcommand*{\sretev}[2]{{\tt ret}(#1,\, #2)}
\newcommand*{\swrapev}[2]{{\tt wrap}(#1,\, #2)}
\newcommand*{\sany}{{\tt Any}}
\newcommand*{\swc}{\_} 

\DeclarePairedDelimiter\compileaux{\llfloor}{\rrfloor}
\newcommand*{\compile}[2]{\compileaux{#1}_{#2}}
\newcommand*{\salloc}[1]{\mathit{alloc}(#1)}
\newcommand*{\sstep}[3]{\mathit{\delta{}step}(#1,\,#2,\,#3)}

\newcommand*{\pmsmstepd}[2]{\overset{#1}{\underset{#2}{\to}}}
\newcommand*{\pmsmstep}[2]{\overset{#1}{\to}}
\newcommand*{\multistepd}[2]{\overset{#1}{\underset{#2}{\to\!\!\!\!\!\to}}}
\newcommand*{\multistep}[2]{\overset{#1}{\to\!\!\!\!\!\to}}

\newcommand*{\denote}[1]{[\![ #1 ]\!]}
\newcommand*{\denotetcon}[1]{P[\![ #1 ]\!]}
\newcommand*{\denotetconfull}[1]{F[\![ #1 ]\!]}
\newcommand*{\denotetcone}[2]{P[\![ #1 ]\!]_{#2}}
\newcommand*{\denotetconfulle}[2]{F[\![ #1 ]\!]_{#2}}

\newcommand*{\denoteevent}[2]{\llparenthesis #1 \rrparenthesis_{#2}}
\newcommand*{\denotevpat}[2]{\llparenthesis #1 \rrparenthesis_{#2}}
\newcommand*{\aptopcall}[2]{{\tt call}^{\toplevel}(#1,\,#2)}
\newcommand*{\apvcall}[2]{{\tt call}(#1,\,#2)}
\newcommand*{\apwrapev}[2]{{\tt wrap}(#1,\,#2)}
\newcommand*{\apvcallalone}{{\tt call}}
\newcommand*{\apvretalone}{{\tt ret}}
\newcommand*{\apwrapalone}{{\tt wrap}}
\newcommand*{\aptopret}[3]{{\tt ret}_{#3}^{\toplevel}(#1,\,#2)}
\newcommand*{\apvret}[3]{{\tt ret}_{#3}(#1,\,#2)}
\newcommand*{\apneg}[1]{{\tt not}#1}

\newcommand*{\spush}[2]{#1 : #2}

\newcommand*{\attach}[2]{\mathit{attach}(#1,\, #2)}

% Values
\newcommand*{\varr}[3]{#2 \mapsto^{#1} #3}
\newcommand*{\sconval}[1]{\tuple{mfun}{#1}}
\newcommand*{\sflatconval}[1]{\tuple{mcon}{#1}}
\newcommand*{\blackhole}{\bullet}
\newcommand*{\vconsf}[2]{\tuple{consD}{#1}_{#2}}
\newcommand*{\vcons}[2]{\tuple{\scons}{#1,\, #2}}
\newcommand*{\vconst}[3]{\tuple{\scons}{#1,\, #2}_{#3}}
\newcommand*{\vMon}[2][\ ]{\tuple[#1]{mon}{#2}}
\newcommand{\bclosarrow}[2]{%
  \mathrel{\vbox{\offinterlineskip\ialign{%
    \hfil##\hfil\cr
    $\scriptscriptstyle#1$\cr
    %\noalign{\kern0ex}
    $\dashrightarrow$\cr
    %\noalign{\kern0ex}
    $\scriptscriptstyle#2$\cr
}}}}
\newcommand*{\bclos}[8]{#1 : #2^{#3} \bclosarrow{#4}{#5} #6^{#7} \chevron{#8}}

% Notation
\newcommand*{\many}[1]{\overline{#1}}
\newcommand*{\combinef}[2]{#1 \mathrel{\triangleleft} #2}
\newcommand*{\combinepat}[2]{#1 \mathrel{\bowtie} #2}
\newcommand*{\combinepatalone}{\bowtie}
\newcommand*{\combinefalone}{\triangleleft}

\newcommand*{\mfail}{\mathbf{fail}}
\newcommand*{\smatch}[2]{{#1}_{#2}}

\newcommand*{\prefixof}[2]{#1 \text{ is a prefix of } #2}

\newcommand*{\negateM}{\sim\!}
\newcommand*{\unionM}{\doublecup}
\newcommand*{\intersectM}{\doublecap}
\newcommand*{\seqM}{\mathit{seq}}
\newcommand*{\derive}[2]{\partial_{#1}{#2}}

% Spaces
\newcommand*{\Prog}{\mathit{Program}}
\newcommand*{\Defines}{\mathit{Definition}}
\newcommand*{\Contract}{\mathit{Contract}}
\newcommand*{\SContract}{\mathit{Structural}}
\newcommand*{\TContract}{\mathit{Temporal}}
\newcommand*{\Event}{\mathit{Event}}
\newcommand*{\BEvent}{\mathit{BEvent}}
\newcommand*{\VPat}{\mathit{VarPattern}}
\newcommand*{\Constant}{\mathit{Constant}}
\newcommand*{\PreValue}{\mathit{PreValue}}
\newcommand*{\PreMonitor}{\mathit{PreMonitor}}
\newcommand*{\ModuleLabel}{\mathit{ModLabel}}
\newcommand*{\MStore}{\mathit{MStore}}
\newcommand*{\Unit}{\mathit{Unit}}
\newcommand*{\Graph}{\mathit{Graph}}
\newcommand*{\ECtx}{\mathit{ExpContext}}
\WithSuffix\newcommand\ECtx*{\mathit{Simple\mctx{\toplevel}}}
\newcommand*{\TMons}{\mathit{PMSMStates}}
\newcommand*{\PMSM}{\mathit{PMSM}}

\newcommand*{\TConEnvStack}{\mathit{Following}}
\newcommand*{\BindEnv}{\mathit{BEnv}}

\newcommand*{\Name}{\mathit{Name}}

\newcommand*{\Timeline}{\mathit{Timeline}}
\newcommand*{\Frame}{\mathit{Frame}}

\newcommand*{\Pattern}{\mathit{Pattern}}
\newcommand*{\Subpattern}{\mathit{Subpattern}}
\newcommand*{\Qualified}{\mathit{Data}}
\newcommand*{\MatchResult}{\mathit{Result}}

\newcommand*{\QState}{\mathit{QState}}
\newcommand*{\MatchState}{\mathit{MState}}
\newcommand*{\Machine}{\mathit{Machine}}
\newcommand*{\BMachine}{\mathit{BMachine}}
\newcommand*{\Quality}{\mathit{Quality}}
\newcommand*{\machcombo}[1]{\mathbf{cmb}(#1)}
\newcommand*{\machbind}[2]{\mathbf{bnd}(#1,\, #2)}

\newcommand*{\Valuation}{\mathit{Valuation}}
\newcommand*{\StepMachine}{\mathit{StepMach}}
\newcommand*{\interpT}[4]{\llparenthesis #1 \rrparenthesis^{#2, #3}_{#4}}


% Imports for the paper
\usepackage{alltt,mathpartir,multicol}
\usepackage{natbib}
\usepackage{amssymb}
\usepackage{url}
\usepackage{graphicx,color}
\usepackage{anyfontsize}
\usepackage{balance}
\usepackage{calc}
\usepackage[english]{babel}
\usepackage[hidelinks]{hyperref}
\usepackage{cleveref}
\usepackage{placeins}