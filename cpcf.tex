\documentclass[preprint,onecolumn,9pt]{sigplanconf} %{onecol}
\usepackage{alltt,mathpartir}
\usepackage{amsmath,amsthm}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{url}
\usepackage{graphicx}
\usepackage{balance}
\usepackage{calc}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}

\newcommand{\naive}{naive}
\newcommand{\naively}{naively}
\newcommand{\Naive}{Naive}
\newcommand{\Naively}{Naively}
% \usepackage{xltxtra}
% \setmonofont[Scale=MatchLowercase]{DejaVu Sans Mono}
%
\input{preamble}

\begin{document}

\conferenceinfo{WXYZ '05}{date, City.}
\copyrightyear{2005}
\copyrightdata{[to be supplied]}
\title{Static Verification of Temporal Higher-Order Contracts}

\authorinfo{J. Ian Johnson}
           {Northeastern University}
           {ianj@ccs.neu.edu}
\authorinfo{Nicholas Alexander Marquez}
           {Northeastern University}
           {nam@ccs.neu.edu}
\authorinfo{David Van Horn}
           {Northeastern University}
           {dvanhorn@ccs.neu.edu}
\maketitle
\begin{abstract}
  Shwazam.
\end{abstract}

\section{Everything Technical}
Syntax:
\begin{align*}
\mexp \in \Expr &::=
      \svar[^\mlab]{\mvar}
 \alt \sapp[^\mlab]{\mexp}{\mexp}
 \alt \slam[^\mlab]{\mvar}{\mexp} \\
&\alt \sif[^\mlab]{\mexp}{\mexp}{\mexp} 
 \alt \sMon{\mmlab}{\mmlab}{\mlab}{\mcontract, \mexp}
 \alt \slit{\mconstant} \\
\mconstant \in \Constant &= -1 \alt 0 \alt 1 \alt \ldots \alt \strue \alt \sfalse \alt \scons \alt \scar \alt \ldots \\
\mvar \in \Var &\text{ an infinite set} \\
\mlab \in \Label &\text{ an infinite set} \\
\mmlab,\mname \in \ModuleLabel &\text{ an infinite set} \\
\msmlab \in \ModuleLabel^{\toplevel} &::= \mmlab \alt \toplevel \\
\mcontract \in \Contract &= \SContract \times \TContract \\
\mscon \in \SContract &::= \sflat{\mexp} \alt \sarr{\mname}{\mscon}{\mscon} \alt \sconsc{\mscon}{\mscon} \\
\mtcon \in \TContract &::=
      \mevent
 \alt \snonevent{\mevent}
 \alt \stnot{\mtcon}
 \alt \stOr{\mtcon}{\mtcon}
 \alt \stseq{\mtcon}{\mtcon}
 \alt \stmany{\mtcon}
 \alt \sddd \\
\mevent \in \Event &::= \scallev{\mname}{\mvpat} \alt \sretev{\mname}{\mvpat} \\
\mvpat \in \VPat &::= \mname \alt \swc \alt \mconstant
\end{align*}

Wrapping monitors around values associates entirely fresh NFA
states. The names given to bindings are really associated with the
bindings. We have to give up some precision for decidability --- we
use a monovariant allocation scheme for monitor allocation. This
scheme allows us to lift all textual temporal contracts to the top
level and check individually. A polyvariant scheme would require
either knowing how many abstract bindings are allocated during
execution, or an exhaustive enumeration of possible bindings as
propositions to check. Since we run CFA before appealing to the model
checker, the former is feasible, but it distracts from the overall
exposition.

Value space:
\begin{align*}
  \mval \in \Value &=
    \clos{\mvar, \mexp, \menv}
   \alt \blclos{\mname}{\mmlab}{\mmlab}{\mlab}{\mscon}{\mscon}{\menv}{\mtimeline}{\maddr}
   \alt \mconstant
   \alt \blackhole \\
&  \alt \vconsf{\maddr}
   \alt \vcons{\maddr}{\maddr}
   \alt \vconst{\maddr}{\maddr}{\mstimeline}
   \alt \sunit \\
  \menv \in \Env &= \Var \parto (\Addr \times \Timeline^{\toplevel}) \\
  \maddr \in \Addr &\text{ an infinite set} \\
  \mstimeline \in \Timeline^{\toplevel} &::= \maddr \alt \toplevel \\
  \mnames &\in \wp(\Var) \\
\end{align*}

State space:
\begin{align*}
  \mstate \in \State &::=
      \ev[^\mlab]{\mexp, \menv, \msto, \mkont}{\msmlab}{\mstimeline}
 \alt \co{\mkont, \mval, \msto}{\msmlab}{\mstimeline} \\
&\alt \ap[^\mlab]{\mval, \mval, \msto, \mkont}{\msmlab}{\mstimeline}
 \alt \ck{\mmlab}{\mmlab}{\mlab}{\pm}{\mscon, \maddr, \menv, \mval, \msto, \mkont}{\msmlab}{\mstimeline}
 \alt \sblame{\mmlab} \\
\msto \in \Store &= \Addr \parto \wp(\Storeable) \\
\Storeable &= \Value + \Kont + \TContract \\
\mframe \in \Frame &::=
      \kar[^\mlab]{\mexp,\menv}
 \alt \kfn[^\mlab]{\mval}
 \alt \kif{\mexp, \mexp, \menv} \\
&\alt \krt{\mmlab, \mtimeline}
 \alt \kmon{\mmlab}{\mmlab}{\mlab}{\mscon, \mtimeline, \menv}
 \alt \kflat[^\mlab]{\mmlab, \mval} \\
&\alt \kchkA[^\mlab]{\mmlab, \mmlab, \mscon, \maddr, \maddr, \maddr}
 \alt \kchkD[^\mlab]{\mmlab, \mmlab, \maddr, \maddr, \maddr, \maddr}
 \alt \kcheck[^\mlab]{\mmlab, \mval} \\
&\alt \kpost[^\mlab]{\mscon, \mtimeline, \menv}
 \alt \kmcall{\mmlab}{\mmlab}{\mlab}{\mscon, \mtimeline, \menv, \mname, \maddr} \\
\mkont \in \Kont &::= \kmt \alt \spush{\mframe}{\mkaddr}
\end{align*}

% \begin{align*}
%     \accept &: \ModuleLabel \times \ModuleLabel \times \Label \times \SContract \times \Value \\
%             &\to (\Value \times \Store) + \Expr + \bot
% \end{align*}
% \begin{align*}
%   \accept(\mmlab_u, \mmlab_c, \mlab, \sarr{\mname}{\mscon_D}{\mscon_R}, \mval) &=
%           \blclos{\mname}{\mmlab_u}{\mmlab_c}{\mlab}{\mscon_D}{\mscon_R}{\menv}{\maddr}, \\
% \phantom{\accept(\mmlab_u, \mmlab_c, \mlab, \sarr{\mname}{\mscon_D}{\mscon_R}, \mval)} &\phantom{= }
%           \ext{\msto}{\maddr}{\setof{\mval}} \\
%   \text{if } \mval \equiv \clos{\mvar, \mexp, \menv'} \text{ or }&
%              \mval \equiv \blclos{\mname'}{\mmlab_u'}{\mmlab_c'}{\mlab'}{\mscon_D'}{\mscon_R'}{\menv'}{\maddr'}
%   \\
%   \accept(\mmlab_u, \mmlab_c, \mlab, \sflat(\mexp), \mval) &= \mexp \\
%   \accept(\mmlab_u, \mmlab_c, \mlab, \sarr{\mname}{\mscon_D}{\mscon_R}, \mval) &= \bot \text{ otherwise}
% \end{align*}

\begin{figure*}
  \begin{gather*}
    \begin{array}{@{}r@{\ }c@{\ }l@{}}
      \mstate & \machstep &\mstate' \text{ defined to be the following} \\
      %% EVAL
      \ev{\svar\mvar, \menv, \msto, \mkont}{\msmlab}{\mstimeline} &\machstep&
      \co{\mkont, \mval, \msto}{\msmlab}{\mstimeline}
      \text{ if } (\maddr, \mstimeline') = \menv(\mvar), \mval \in \msto(\maddr)
      \\
    %%
      \ev{\sapp[^\mlab]{\mexpi0}{\mexpi1}, \menv, \msto, \mkont}{\msmlab}{\mstimeline} &\machstep&
      \ev{\mexpi0, \menv, \msto', \spush{\kar[^\mlab]{\mexpi1, \menv}}{\mkaddr}}{\msmlab}{\mstimeline}
      \\
      &&\text{where } \mkaddr = \alloc(\mstate) \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\mkaddr}{\setof{\mkont}} \\
      %%
      \ev{\sif{\mexpi0}{\mexpi1}{\mexpi2}, \menv, \msto, \mkont}{\msmlab}{\mstimeline} &\machstep&
      \ev{\mexpi0, \menv, \msto', \spush{\kif{\mexpi1, \mexpi2, \menv}}{\mkaddr}}{\msmlab}{\mstimeline} \\
      &&\text{where } \mkaddr = \alloc(\mstate) \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\mkaddr}{\setof{\mkont}} \\
     %%
      \ev{\slam{\mvar}{\mexp}, \menv, \msto, \mkont}{\msmlab}{\mstimeline} &\machstep&
      \co{\mkont, \clos{\mvar, \mexp, \menv}, \msto}{\msmlab}{\mstimeline}
      \\
      %%
      \ev{\slit{\mconstant}, \menv, \msto, \mkont}{\msmlab}{\mstimeline} &\machstep&
      \co{\mkont, \mconstant, \msto}{\msmlab}{\mstimeline}
      \\
      %%
      %% CONTINUE
      \co{\spush{\kif{\mexpi0, \mexpi1, \menv}}{\mkaddr}, \strue, \menv, \msto}{\msmlab}{\mstimeline} &\machstep&
      \ev{\mexpi0, \menv, \msto, \mkont}{\msmlab}{\mstimeline} \text{ if } \mkont \in \msto(\mkaddr)
      \\
      %%
      \co{\spush{\kif{\mexpi0, \mexpi1, \menv}}{\mkaddr}, \sfalse, \menv, \msto}{\msmlab}{\mstimeline} &\machstep&
      \ev{\mexpi1, \menv, \msto, \mkont}{\msmlab}{\mstimeline} \text{ if } \mkont \in \msto(\mkaddr)
      \\
      %%
      \co{\spush{\kar[^\mlab]{\mexp, \menv}}{\mkaddr}, \mval, \msto}{\msmlab}{\mstimeline} &\machstep&
      \ev[^\mlab]{\mexpi, \menv, \msto', \spush{\kfn[^\mlab]{\mval}}{\mkaddr}}{\msmlab}{\mstimeline}
      \\
      && \text{where } \maddr' = \alloc(\mstate) \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\maddr'}{\setof{\mval}} \\
      %%
      \co{\spush{\kfn[^\mlab]{\mval_f}}{\mkaddr}, \mval, \msto}{\msmlab}{\mstimeline} &\machstep&
      \ap{\mval_f, \mval, \msto, \mkont}{\msmlab}{\mstimeline} \text{ if } \mkont \in \msto(\mkaddr)
      \\
      %%
      %% APPLY
      \ap{\clos{\mvar, \mexp, \menv}, \mval, \msto, \mkont}{\msmlab}{\mstimeline} &\machstep&
      \ev{\mexp, \menv', \msto', \mkont}{\msmlab}{\mstimeline} \\
      &&\text{where } \maddr = \alloc(\mstate) \\
      &&\phantom{\text{where }} \menv' = \menv[\mvar \mapsto (\maddr, \mstimeline)] \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\maddr}{\setof{\mval}}
    \end{array}    
  \end{gather*}
  \caption{Standard reduction rules}
  \label{fig:standard}
\end{figure*}

\begin{figure*}
  \begin{gather*}
    \begin{array}{@{}r@{\ }c@{\ }l@{}}
      \mstate & \machstep &\mstate' \text{ defined to be the following} \\
      %% EVAL
      \ev{\sMon{\mmlab_u}{\mmlab_c}{\mlab}{(\mscon, \mtcon), \mexp}, \menv, \msto, \mkont}
         {\msmlab}{\mstimeline} &\machstep&
      \ev[^\mlab]{\mexp, \menv, \msto', \spush{\kmon{\mmlab_u}{\mmlab_c}{\mlab}{\mscon, \mtimeline, \menv}}{\mkaddr}}
         {\msmlab}{\mstimeline} \\
      &&\text{where } (\mkaddr, \mtimeline) = \alloc(\mstate) \\
      &&\phantom{\text{where }}
         \msto' = \msto \sqcup [\mkaddr \mapsto \setof{\mkont},
                                \mtimeline \mapsto \setof{\mtcon}]
      \\
      %%
      %% CONTINUE
      \co{\spush{\krt{\mmlab',\mtimeline'}}{\mkaddr}, \mval, \msto}
         {\msmlab}{\mstimeline}
        &\machstep&
      \co{\mkont, \mval, \msto}
         {\mmlab'}{\mtimeline'} \text{ if } \mkont \in \msto(\mkaddr)
      \\
      %%
      \co{\spush{\kmon{\mmlab_u}{\mmlab_c}{\mlab}{\mscon, \mtimeline, \menv}}{\mkaddr}, \mval, \msto}
         {\msmlab}{\mstimeline} &\machstep&
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{+}
         {\mscon, \mtimeline, \menv, \mval, \msto, \mkont}
         {\msmlab}{\mstimeline} \text{ if } \mkont \in \msto(\mkaddr)
      \\
      %%
      %% Administrative contract checking
      %% Flat
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{\mvariance}
         {\sflat{\mexp}, \mtimeline, \menv, \mval, \msto, \mkont}
         {\msmlab}{\mstimeline} &\machstep&
      \ev{\mexp, \menv, \msto', \spush{\kflat[^\mlab]{\mmlab_p, \mval}}{\mkaddr}}
         {\msmlab}{\mstimeline} \\
      &&\text{where } \mkaddr = \alloc(\mstate) \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\mkaddr}{\setof{\mkont}} \\
      &&\phantom{\text{where }} \mmlab_p = \varianceite{\mvariance}{\mmlab_u}{\mmlab_c}
      \\
      % %% Higher-order
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{\mvariance}
         {\sarr{\mname}{\mscon_D}{\mscon_R}, \mtimeline, \menv, \mval, \msto, \mkont}
         {\msmlab}{\mstimeline} &\machstep&
      \co{\mkont, \blclos{\mname}{\mmlab_u}{\mmlab_c}{\mlab}{\mscon_D}{\mscon_R}{\menv}{\mtimeline}{\maddr}, \msto'}
         {\msmlab}{\mstimeline} \\
      &\text{ if }& \mval \equiv \clos{\mvar, \mexp, \menv'}
       \text{ or }  \mval \equiv \blclos{\mname'}{\mmlab_u'}{\mmlab_c'}{\mlab'}{\mscon_D'}{\mscon_R'}{\menv'}{\mtimeline'}{\maddr'} \\
      &&\text{where } \maddr = \alloc(\mstate) \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\maddr}{\setof{\mval}}
      \\
      %%
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{\mvariance}
         {\sarr{\mname}{\mscon_D}{\mscon_R}, \mtimeline, \menv, \mval, \msto, \mkont}
         {\msmlab}{\mstimeline} &\machstep&
      \sblame{\mmlab_p} \\
      &\text{ if }& \mval \nequiv \clos{\mvar, \mexp, \menv'}
       \text{ and } \mval \nequiv \blclos{\mname'}{\mmlab_u'}{\mmlab_c'}{\mlab'}{\mscon_D'}{\mscon_R'}{\menv'}{\mtimeline'}{\maddr'} \\
      &&\text{where } \mmlab_p = \varianceite{\mvariance}{\mmlab_u}{\mmlab_c}
      \\
      %% CONS CONTRACT
      % Start checking car
      \co{\spush{\kmon{\mmlab_u}{\mmlab_c}{\mlab}{\sconsc{\mscon_A}{\mscon_D}, \mtimeline, \menv}}{\mkaddr},
          \mval,
          \msto}
         {\msmlab}{\mstimeline} &\machstep&
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{+}
         {\mscon_A,
          \mtimeline,
          \menv,
          \mval_A,
          \msto,
          \spush{\kchkA[^{\mmlab_u, \mmlab_c}_\mlab]{\mscon_D, \mtimeline, \menv, \maddr'_A, \maddr'_D, \maddr_D}}
                {\mkaddr}}
         {\msmlab}{\mstimeline} \\
      &\text{ if }& \mval \equiv \vcons{\maddr_A}{\maddr_D} \text{ or }
                    \mval \equiv \vconst{\maddr_A}{\maddr_D}{\mstimeline'} \text{ and } \mval_A \in \msto(\maddr_A) \\
      &&\text{where } (\maddr'_A, \maddr'_D) = \alloc(\mstate)
      \\
      % Start checking cdr
      \co{\spush{\kchkA[^{\mmlab_u, \mmlab_c}_\mlab]{\mscon_D, \mtimeline, \menv, \maddr'_A, \maddr'_D, \maddr_D}}{\mkaddr},
          \mval, \msto}
         {\msmlab}{\mstimeline} &\machstep&
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{+}
         {\mscon_D, \mtimeline, \menv, \mval_D, \msto',
                                \spush{\kchkD{\maddr'_A, \maddr'_D, \mtimeline}}{\mkaddr}}
         {\msmlab}{\mstimeline}
      \text{ if } \mval_D \in \msto(\maddr_D) \\
      &&\text{where } \msto' = \ext{\msto}{\maddr'_A}{\setof{\mval}}
      \\
      %%
      % End checking cdr
      \co{\spush{\kchkD{\maddr_A, \maddr_D, \mtimeline}}{\mkaddr}, \mval, \msto}
         {\msmlab}{\mstimeline}
       &\machstep&
      \co{\mkont, \vconst{\maddr_A}{\maddr_D}{\mtimeline}, \ext{\msto}{\maddr_D}{\setof{\mval}}}
         {\msmlab}{\mstimeline}
        \text{ if } \mkont \in \msto(\mkaddr)
      \\
      %% END CONS CONTRACT
      %%
      \co{\spush{\kflat[^\mlab]{\mmlab_u, \mval'}}{\mkaddr}, \mval, \msto}{\msmlab}{\mstimeline} &\machstep&
      \ap[^\mlab]{\mval, \mval', \msto, \spush{\kcheck{\mmlab_u, \mval'}}{\mkaddr}}{\msmlab}{\mstimeline}
      \\
      %%
      \co{\spush{\kcheck{\mmlab_u, \mval}}{\mkaddr}, \strue, \msto}{\msmlab}{\mstimeline} &\machstep&
      \co{\mkont, \mval, \msto}{\msmlab}{\mstimeline} \text{ if } \mkont \in \msto(\mkaddr)
      %% \attach{\mval_C}{\mval}
      \\
      %%
      \co{\spush{\kcheck{\mmlab_u, \mval}}{\mkaddr}, \sfalse, \msto}{\msmlab}{\mstimeline} &\machstep&
      \sblame{\mmlab_u}
      \\
      %%
      \co{\spush{\kmcall{\mmlab_u}{\mmlab_c}{\mlab}{\mscon_R, \mtimeline, \menv, \mname, \maddr}}{\mkaddr},
          \mval,
          \msto}{\msmlab}{\mstimeline} &\machstep&
      \ap{\mval_f,
          \mval,
          \msto,
          \spush{\kpost[^{\mmlab_u, \mmlab_c}_\mlab]{\mscon_R, \mtimeline, \menv, \msmlab}}{\mkaddr}}
         {\mname}{\mtimeline}
        \text{ if } \mval_f \in \msto(\maddr)
      \\
      %%
      % Start checking the post-condition before returning
      \co{\spush{\kpost[^{\mmlab_u, \mmlab_c}_\mlab]{\mscon_R, \mtimeline, \menv, \mname}}{\mkaddr}, \mval, \msto}
         {\msmlab}{\mstimeline}
       &\machstep&
      \ck{\mmlab_u}{\mmlab_c}{\mlab}{+}
         {\mscon_R, \menv, \mval, \msto, \spush{\krt{\mname, \mtimeline}}{\mkaddr}}
         {\msmlab}{\mstimeline}
      \\
      %%
      %% APPLY
      \ap[^\mlab]{\blclos{\mname}{\mmlab_u}{\mmlab_c}{\mlab'}{\mscon_D}{\mscon_R}{\menv}{\mtimeline}{\maddr},
                  \mval,
                  \msto,
                  \mkont}
                 {\msmlab}{\mstimeline} &\machstep&
      \ck{\mmlab_u}{\mmlab_c}{\mlab'}{-}
         {\mscon_D, \menv, \mval, \msto',
          \spush{\kmcall{\mmlab_u}{\mmlab_c}{\mlab}{\mscon_R, \mtimeline, \menv, \mname, \maddr}}{\mkaddr}}
         {\msmlab}{\mstimeline} \\
      &&\text{where } \mkaddr = \alloc(\mstate) \\
      &&\phantom{\text{where }} \msto' = \ext{\msto}{\mkaddr}{\setof{\mkont}}
      %%
    \end{array}
  \end{gather*}
  \caption{Non-standard rules}
\label{fig:concrete}
\end{figure*}
%\balance
%\bibliographystyle{plain}
%\input{paper.bbl}
%\bibliography{local,bibliography}

% \include{appendix}
\end{document}